@inherits Nancy.ViewEngines.Razor.NancyRazorViewBase<TvTunerService.Models.BrowseEztvModel>
@{
    Layout = "Views/Shared/_Layout.cshtml";
}

<div class="row">
    <div class="col-sm-6">
        <div class=" input-group">
            <input type="text" class="form-control" placeholder="Show title..." id="searchTerm" />
            <span class="input-group-btn">
                <button class=" btn btn-default" type="button" id="SearchShows">Search</button>
            </span>
        </div>
    </div>
</div>

@{
    var showResultsStyle = (Model.Episodes != null) ? "display:none;" : "";
    var showEpisodesStyle = (Model.Episodes != null) ? "" : "display:none;";
}

<div id="ShowResults" style="@showResultsStyle">
    <div class="row">
        <div class="col-sm-6">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th class="hidden">Show ID</th>
                        <th>Title</th>
                        <th>Status</th>
                        <th></th> <!--Button column-->
                    </tr>
                </thead>
                <tbody>
                    @foreach (var show in Model.Shows) {
                        <tr>
                            <td class='showId hidden'>@show.Id</td>
                            <td class='showTitle'> @show.Title</td>
                            <td class='showStatus'>@show.Status</td>
                            <td><button type='button' class='btn btn-default getShowBtn'>Get Episodes</button></td>
                        </tr>
                    }

                </tbody>
            </table>
        </div>
    </div>
</div>
<div id="EpisodeResults" style="@showEpisodesStyle">
    <div class="row">
        <div class="col-sm-6">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th class="hidden"></th>
                        <th id="episodeShowTitle" colspan="2">@(Model.Episodes != null ? Model.Episodes.ShowTitle : "Show Name")</th>
                        <th id="episodeCount" colspan="2">@(Model.Episodes != null ? Model.Episodes.Episodes.Count : 0) Episodes</th>
                    </tr>
                    <tr>
                        <th class="hidden">Episode ID</th>
                        <th>Season</th>
                        <th>Episode</th>
                        <th>Title</th>
                        <th></th> <!--button column to add to library-->
                    </tr>
                </thead>
                <tbody>
                    @if (Model.Episodes != null) {
                        foreach (var episode in Model.Episodes.Episodes) {
                            <tr>
                                <td class='episodeId hidden'>@episode.ID</td>
                                <td class='episodeSeason'>@episode.Season</td>
                                <td class='episodeNumber'>@episode.EpisodeNum</td>
                                <td class='episodeTitle'>@episode.Title </td>
                                <td><button type='button' class='btn btn-default addEpisode' data-magnet='@episode.Magnet'>Add Episode</button></td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>
<div class="modal fade" id="showModal">
    <input type="hidden" id="originalShowName" />
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">Look up Show in TVDB</h4>
            </div>
            <div class="modal-body">
                <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
                    <div class="panel panel-default">
                        <div class="panel-heading" role="tab" id="headingOne">
                            <h4 class="panel-title">
                                <a data-toggle="collapse" data-parent="#accordion" href="#showInformation" aria-expanded="true" aria-controls="collapseOne">
                                    Show Information
                                </a>
                            </h4>
                        </div>
                        <div id="showInformation" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="headingOne">
                            <div class="panel-body">
                                <div>
                                    <label for="modalShowName">Show Name:</label>
                                    <div class="input-group">
                                        <input type="text" id="modalShowName" class="form-control" />
                                        <span class="input-group-btn">
                                            <button class="btn btn-default" type="button" id="btnTVDBLookupShow">Lookup</button>
                                        </span>
                                    </div>
                                    <select id="modalPickShow" size="5" style="display:none"></select>
                                </div>
                                <img id="modalShowBanner" src="" />
                                <div id="modalShowSummary" class="well"></div>
                                <button type="button" class="btn btn-primary" id="btnSaveShow" style="display: none">Save Show Info</button>
                            </div>
                        </div>
                    </div>
                    <div class="panel panel-default">
                        <div class="panel-heading" role="tab" id="headingOne">
                            <h4 class="panel-title">
                                <a class="collapsed" data-toggle="collapse" data-parent="#accordion" href="#episodeInformation" aria-expanded="true" aria-controls="collapseOne">
                                    Episode Information
                                </a>
                            </h4>
                        </div>
                        <div id="episodeInformation" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne">
                            <div class="panel-body">
                                <div class="form-horizontal">
                                    <div class="form-group">
                                        <label for="modalEpisodeSeason" class="col-sm-2 control-label">Season</label>
                                        <div class="col-sm-10">
                                            <input type="text" id="modalEpisodeSeason" class="form-control" />
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="modalEpisodeNum" class="col-sm-2 control-label">Episode</label>
                                        <div class="col-sm-10">
                                            <input type="text" id="modalEpisodeNum" class="form-control" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="btnSaveEpisode">Save changes</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<script>
    $(function () {
        $("#btnSaveEpisode").on("click", function () {
            var showName = $("#modalShowName").val();
            var summary = $("#modalShowSummary").text();
            var bannerUrl = $("#modalShowBanner").attr("src");


            $.post(
                getBaseURL() + "shows/show/update/" + showName,
                {
                    ShowName: showName,
                    Summary: summary,
                    BannerUrl: bannerUrl
                },
                function (data) {
                    if (data === "Success") {
                        $("#showModal").modal('hide');
                    } else {
                        $("#btnSaveShow").parent().append(
                            '<div class="alert alert-success alert-dismissible fade in" role="alert">' +
                            '<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">×</span></button>' + data + '</div>'
                        );
                    }
                }
            );
        });

        $("#modalPickShow").on("click", "option", function () {
            $.get(getBaseURL() + "tvdb/ShowInformation/" + $(this).val(),
                function (data2) {
                    spinner.stop();
                    $("#modalShowName").val(data2.Name);
                    $("#modalShowSummary").text(data2.Summary);
                    $("#modalShowBanner").attr("src", getBaseURL() + data2.BannerPath);
                    $("#btnSaveShow").show();
                }
            );
        });

        $("#btnTVDBLookupShow").on("click", function () {
            var search = $("#modalShowName").val();
            spinner.spin(document.getElementById('showModal'));
            var lb = $("#modalPickShow");
            lb.html('');
            $.get(getBaseURL() + "tvdb/lookupshow/",
                {
                    search: search
                }, function (data) {
                    if (data.length == 1) {
                        lb.hide();
                        $.get(getBaseURL() + "tvdb/ShowInformation/" + data[0].Item2,
                            function (data2) {
                                spinner.stop();
                                $("#modalShowName").val(data2.Name);
                                $("#modalShowSummary").text(data2.Summary);
                                $("#modalShowBanner").attr("src", getBaseURL() + data2.BannerPath);
                                $("#btnSaveShow").show();
                            }
                        );
                    } else if (data.length > 1) {
                        lb.show();
                        $(data).each(function (i, elem) {
                            lb.append("<option value='" + elem.Item2 + "'>" + elem.Item1 + "</option>");
                        });
                    }
                }
            );
        });



        $("#EpisodeResults").on("click", ".addEpisode", function () {
            spinner.spin(document.getElementById('EpisodeResults'));
            ClearModal();
            var magnet = $(this).data("magnet");
            var showName = $("#episodeShowTitle").text();
            var season = $(this).parents("tr").find(".episodeSeason").text();
            var episodeNum = $(this).parents("tr").find(".episodeNumber").text();


            $.post(
                getBaseURL() + "EZTV/AddToLibrary",
                {
                    ShowName: showName,
                    MagnetLink: magnet,
                    Season: season,
                    EpisodeNumber: episodeNum
                },
                function (data) {
                    spinner.stop();
                    if (data.indexOf("Success") >= 0) {
                        //alert(data);
                        $("#modalShowName").val(showName);
                        $("#modalEpisodeSeason").val(season);
                        $("#modalEpisodeNum").val(episodeNum);
                        $("#originalShowName").val(showName);
                        $("#showModal").modal();
                        GetShowInformation();


                    } else {
                        alert(data);
                    }
                }
            );

        });

        $("#ShowResults").on("click", ".getShowBtn", function () {
            console.log(this);
            var id = $(this).parents("tr").find("td.showId").text();
            var title = $(this).parents("tr").find("td.showTitle").text();
            console.log(id);
            spinner.spin(document.getElementById('ShowResults'));
            $("#EpisodeResults tbody").html("");
            document.location.search = "?q=" + title + "&episodes=true";
        });

        $("#SearchShows").on("click", function () {
            $("#EpisodeResults").fadeOut(function () {
                $("#ShowResults").fadeIn();
            });
            $("#ShowResults tbody").html("");
            var fragment = $("#searchTerm").val();
            spinner.spin(document.getElementById('ShowResults'));
            window.location.search = "?q=" + fragment;
        });
        $("#searchTerm").on("keypress", function (e) {
            if (e.keyCode === 13) {
                $("#SearchShows").click();
            }
        });
    });
    function ClearModal() {
        $("#modalShowName").val('');
        $("#modalShowBanner").attr('src', '');
        $("#modalShowSummary").text('');
        $("#btnSaveShow").hide();
        $("#modalEpisodeSeason").val('');
        $("#modalEpisodeNum").val('');
        $("#modalPickShow").html('').hide();
    }
    function GetShowInformation() {
        var search = $("#modalShowName").val();
        spinner.spin(document.getElementById('showModal'));
        $.get(getBaseURL() + "tvdb/lookupshow/",
            {
                search: search
            }, function (data) {
                if (data.length == 1) {
                    $.get(getBaseURL() + "tvdb/ShowInformation/" + data[0].Item2,
                        function (data2) {
                            spinner.stop();
                            $("#modalShowName").val(data2.Name);
                            $("#modalShowSummary").text(data2.Summary);
                            $("#modalShowBanner").attr("src", getBaseURL() + data2.BannerPath);
                        }
                    );
                }
            }
        );
    }

</script>
